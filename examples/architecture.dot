digraph Architecture {
    rankdir=TB;
    node [shape=box, style=filled, fillcolor=white];
    graph [fontname="Helvetica", nodesep=0.5, ranksep=0.8];

    subgraph cluster_driver {
        label = "Driver Node (CPU/Head)";
        style = filled;
        fillcolor = "#e1f5fe";
        
        Trainer [label="RayPPOTrainer\n(Controller)", shape=component, fillcolor="#b3e5fc"];
        ResourceManager [label="ResourcePoolManager"];
        
        Trainer -> ResourceManager [label="allocates"];
    }

    subgraph cluster_cluster {
        label = "Ray Cluster (GPU Nodes)";
        style = filled;
        fillcolor = "#f3e5f5";

        subgraph cluster_pool1 {
            label = "Resource Pool A (e.g. 4 GPUs)";
            style = dashed;
            color = "#7b1fa2";
            
            WorkerGroup1 [label="ActorRolloutRef\nWorkerGroup", shape=folder, fillcolor="#e1bee7"];
            
            node [shape=ellipse, fillcolor="#f8bbd0"];
            W1_Actor [label="Actor\n(FSDP/Megatron)"];
            W1_Rollout [label="Rollout\n(vLLM/SGLang)"];
            W1_Ref [label="RefPolicy"];
            
            WorkerGroup1 -> W1_Actor;
            WorkerGroup1 -> W1_Rollout;
            WorkerGroup1 -> W1_Ref;
            
            {rank=same; W1_Actor; W1_Rollout; W1_Ref}
        }

        subgraph cluster_pool2 {
            label = "Resource Pool B (e.g. 2 GPUs)";
            style = dashed;
            color = "#7b1fa2";
            
            WorkerGroup2 [label="Critic\nWorkerGroup", shape=folder, fillcolor="#e1bee7"];
            W2_Critic [label="Critic Model", shape=ellipse, fillcolor="#f8bbd0"];
            
            WorkerGroup2 -> W2_Critic;
        }

        subgraph cluster_pool3 {
            label = "Resource Pool C (Optional)";
            style = dashed;
            color = "#7b1fa2";
            
            WorkerGroup3 [label="RewardModel\nWorkerGroup", shape=folder, fillcolor="#e1bee7"];
            W3_RM [label="Reward Model", shape=ellipse, fillcolor="#f8bbd0"];
            
            WorkerGroup3 -> W3_RM;
        }
    }

    Trainer -> WorkerGroup1 [label="RPC: update_actor(), generate()", color="blue"];
    Trainer -> WorkerGroup2 [label="RPC: compute_values(), update_critic()", color="blue"];
    Trainer -> WorkerGroup3 [label="RPC: compute_reward()", color="blue"];

    // Data flow annotations
    edge [color="#ef5350", style=dotted, fontsize=10];
    W1_Rollout -> Trainer [label="DataProto\n(Prompts, Responses)"];
    Trainer -> W3_RM [label="Prompts, Responses"];
    W3_RM -> Trainer [label="Scores"];
    Trainer -> W1_Actor [label="Training Batch"];
}


